<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OBF Christmas Pee not Tree!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase compat SDKs for single-file simplicity -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>html,body{background:#eef2ff;}</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useRef,useMemo}=React;
    const clamp=(v,min=0,max=1)=>Math.max(min,Math.min(max,v));
    const rand=(min,max)=>Math.random()*(max-min)+min;
    const G=9.81, ANGLE_RAD=Math.PI/4;

    // ===== Firebase setup (REPLACE with your config) =====
    const firebaseConfig={
      apiKey:"AIzaSyDDf_4ZwQSqoOPPYI240kmUL2D1QEDHTSs",
      authDomain:"svgscience-6bb49.firebaseapp.com",
      projectId:"svgscience-6bb49",
      storageBucket:"svgscience-6bb49.firebasestorage.app",
      messagingSenderId:"493468414507",
      appId:"1:493468414507:web:fc5b8eaa2ea72763d3706e",
      measurementId: "G-2TW8KPGW6L"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();
    const scoresRef=db.collection("scores_siteB");

    const Card=({children,className=""})=> (
      <div className={`rounded-2xl shadow-lg bg-white p-4 ${className}`}>{children}</div>
    );
    const Button=({children,onClick,disabled,className=""})=> (
      <button
        onClick={onClick}
        disabled={disabled}
        className={`w-full rounded-2xl px-4 py-3 font-semibold shadow ${
          disabled
            ? "bg-gray-300 text-gray-500"
            : "bg-indigo-600 text-white active:translate-y-[1px]"
        } ${className}`}
      >
        {children}
      </button>
    );

    function Game(){
      const[stage,setStage]=useState("menu");
      const[name,setName]=useState("");
      const[picks,setPicks]=useState([]);
      const[barPos,setBarPos]=useState(0);
      const[barDir,setBarDir]=useState(1);
      const[running,setRunning]=useState(false);
      const[locked,setLocked]=useState(false);
      const[wind,setWind]=useState(0);
      const[distanceTarget,setDistanceTarget]=useState(130);
      const[score,setScore]=useState(null);
      const[distResult,setDistResult]=useState(null);
      const[selectedVal,setSelectedVal]=useState(null);
      const[showJet,setShowJet]=useState(false);
      const[hit,setHit]=useState(false);
      const[pathRef]=[useRef(null)];
      const[board,setBoard]=useState([]);
      const[boardOpen,setBoardOpen]=useState(true); // leaderboard expand/collapse

      // realtime leaderboard subscription
      useEffect(()=>{
        const unsub=scoresRef.orderBy("score","desc").limit(10).onSnapshot(snap=>{
          const rows=[]; snap.forEach(doc=>rows.push(doc.data()));
          setBoard(rows);
        });
        return unsub;
      },[]);

      // write/overwrite by lowercased name
      async function pushBoardRemote(entry){
        const key=entry.name.trim().toLowerCase()||("anon-"+Math.random().toString(36).slice(2));
        await scoresRef.doc(key).set({
          name: entry.name||"Anon",
          score: entry.score,
          picks: entry.picks,
          hit: entry.hit||false,
          ts: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge:true });
      }

      // ===== BUFFS (NERFED FOR HIGHER DIFFICULTY) =====
      const attrs=useMemo(()=>{
        const p=new Set(picks);
        const aim=1+(p.has("lemonade")?0.3:0);       // was 0.5
        const strength=1+(p.has("breast milk")?0.3:0); // was 0.5
        const push=p.has("wine")?8:0;                // was 12
        return {aim,strength,push};
      },[picks]);

      // ===== BAR ANIMATION (FASTER FOR MORE DIFFICULTY) =====
      const lastTRef=useRef(null);
      useEffect(()=>{
        if(!running||locked) return;
        let raf;
        const speed=5.2; // was 3.8

        const loop=t=>{
          if(!lastTRef.current) lastTRef.current=t;
          const dt=(t-lastTRef.current)/1000; lastTRef.current=t;
          setBarPos(p=>{
            let n=p+dt*speed*barDir;
            if(n>1){n=1-(n-1); setBarDir(-1);}
            if(n<0){n=-n; setBarDir(1);}
            return n;
          });
          raf=requestAnimationFrame(loop);
        };
        raf=requestAnimationFrame(loop);
        return ()=>cancelAnimationFrame(raf);
      },[running,locked,barDir]);

      const beginRound=()=>{
        // Stronger, more chaotic wind for higher difficulty
        setWind(rand(-1.2,0.8));        // was rand(-0.7,0.3)
        setDistanceTarget(rand(120,140));
        setBarPos(Math.random());
        setBarDir(Math.random()<0.5?-1:1);
        setLocked(false); setSelectedVal(null); setScore(null);
        setDistResult(null); setShowJet(false); setHit(false);
        lastTRef.current=null; setStage("play"); setRunning(true);
      };

      const lockStrength=()=>{
        if(!running||locked) return;

        // More jitter -> harder to hit exact value
        const jitterStd=0.03/attrs.aim;    // was 0.01/attrs.aim
        const jitter=rand(-jitterStd,jitterStd);

        const val=clamp(barPos+jitter,0,1);
        setSelectedVal(val);

        const v=val*26*attrs.strength;
        const rangeNoWind=(v*v*Math.sin(2*ANGLE_RAD))/G;
        const eff=rangeNoWind+attrs.push;
        setDistResult(eff);

        const target=distanceTarget+wind;
        const err=Math.abs(eff-target);

        const s=Math.max(0,Math.round(100-err));
        setScore(s);

        // Smaller hit window => harder ‚≠ê
        const didHit=err<3; // was 5
        setHit(didHit);

        const DRAG = 0.03; 
        setLocked(true);
        setRunning(false);
        setShowJet(true);

        pushBoardRemote({ name, score:s, picks:[...picks], hit:didHit, ts:Date.now() });
      };

      const canStart=name.trim().length>0 && picks.length===2;
      const togglePick=id=>setPicks(c=> c.includes(id)? c.filter(x=>x!==id) : (c.length>=2?c:[...c,id]));
      const resetAll=()=> setStage("menu");

      function buildPathD(){
        const startX=10,startY=30,shieldX=75;
        const tgt=(distanceTarget+wind)||1, eff=distResult??0;
        const ratio=clamp(eff/tgt,0,1.25);
        const endX=startX+ratio*(shieldX-startX);
        const midX=(startX+endX)/2;
        const lift=6+(selectedVal??0)*7;
        const apexY=Math.max(6,startY-lift);
        return `M${startX},${startY} Q ${midX.toFixed(2)},${apexY.toFixed(2)} ${endX.toFixed(2)},${startY}`;
      }

      return (
        <div className="min-h-screen w-full bg-gradient-to-b from-indigo-50 to-white text-gray-900">
          <div className="mx-auto max-w-5xl p-4 pb-24">
            <header className="py-4 text-center">
              <h1 className="text-3xl font-extrabold tracking-tight">
                OBF Christmas Pee competition: Can you Pee better than the other?
              </h1>
              <p className="text-sm text-gray-600">
                Tap at the perfect moment to hit PoOlines‚Äôs shield.
              </p>
            </header>

            {/* MAIN LAYOUT: game left, leaderboard right on larger screens */}
            <div className="mt-4 flex flex-col gap-4 md:flex-row md:items-start">
              {/* GAME COLUMN */}
              <div className="order-2 md:order-1 flex-1 max-w-xl mx-auto w-full">
                {stage==="menu" && (
                  <Card className="space-y-4">
                    <div>
                      <label className="text-sm font-medium">Your name</label>
                      <input
                        className="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="Enter your pilot name"
                        value={name}
                        onChange={e=>setName(e.target.value)}
                        inputMode="text"
                      />
                    </div>
                    <div>
                      <div className="text-sm font-medium">Pick two drinks for buffs</div>
                      <div className="mt-2 grid grid-cols-3 gap-2">
                        {[
                          {id:"lemonade",name:"Lemonade",desc:"Aim",emoji:"üçã"},
                          {id:"breast milk",name:"Breast Milk",desc:"Strength",emoji:"üçº"},
                          {id:"wine",name:"Wine",desc:"Push",emoji:"üç∑"},
                        ].map(o=> (
                          <button
                            key={o.id}
                            onClick={()=>togglePick(o.id)}
                            className={`rounded-2xl border px-3 py-3 text-center ${
                              picks.includes(o.id)
                                ? "border-indigo-600 bg-indigo-50"
                                : "border-gray-300 bg-white"
                            }`}
                          >
                            <div className="text-2xl">{o.emoji}</div>
                            <div className="text-sm font-semibold">{o.name}</div>
                            <div className="text-xs text-gray-500">+ {o.desc}</div>
                          </button>
                        ))}
                      </div>
                      <div className="mt-2 text-xs text-gray-500">You can only drink two.</div>
                    </div>
                    <Button onClick={beginRound} disabled={!canStart}>Start</Button>
                  </Card>
